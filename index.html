<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brown Family Guild Hall</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase App/Auth/Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Cinzel:wght@400;700&display=swap');
        :root {
            --skyrim-bg: #121212;
            --skyrim-accent: #f0ad4e;
            --skyrim-silver: #d1d1d1;
            --skyrim-border: rgba(255, 255, 255, 0.15);
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--skyrim-bg);
            color: var(--skyrim-silver);
            background-image: radial-gradient(circle at center, #1e1e1e 0%, #0f0f0f 100%);
            margin: 0;
            overflow-x: hidden;
        }
        .rpg-title { font-family: 'Cinzel', serif; letter-spacing: 0.1em; text-transform: uppercase; }
        .skyrim-progress-bg { background: rgba(0, 0, 0, 0.5); height: 2px; position: relative; }
        .skyrim-progress-fill { height: 100%; background: var(--skyrim-silver); box-shadow: 0 0 8px var(--skyrim-silver); transition: width 0.5s ease-out; }
        .skyrim-progress-fill.amber { background: var(--skyrim-accent); box-shadow: 0 0 8px var(--skyrim-accent); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        .char-card { transition: all 0.3s; background: rgba(30, 30, 30, 0.6); border: 1px solid var(--skyrim-border); cursor: pointer; }
        .char-card.active { border-color: var(--skyrim-accent); background: rgba(50, 50, 50, 0.8); }
        input, select, textarea { background: rgba(0,0,0,0.5) !important; border: 1px solid #333 !important; color: white !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ECONOMY & LEVELING CONFIG ---
        const TIER_COSTS = { Common: 40, Unusual: 100, Rare: 400, Epic: 1000, Legendary: 2500, Mythic: 6000 };
        const MISSION_REWARDS = { daily: 10, weekly: 60, monthly: 250, campaign: 1000 };
        const XP_REWARDS = { daily: 20, weekly: 120, monthly: 500, campaign: 2000 };

        const getLevel = (xp) => Math.floor(Math.sqrt((xp || 0) / 50)) + 1;
        const getXPForLevel = (lvl) => Math.pow(lvl - 1, 2) * 50;

        const rooms_list = ["Kitchen", "Upstairs Bath", "Downstairs Bath", "Laundry Room", "Dining Room", "Living Room", "Eric's Office", "Catie's Office", "Theatre Room", "Rory's Room", "Olive's Room", "Primary Bedroom", "Playroom", "General"];

        const firebaseConfig = {
          apiKey: "AIzaSyB7pIt45QRtW11r5i-PCl_5LhI_clqGr0s",
          authDomain: "brown-family-guild.firebaseapp.com",
          projectId: "brown-family-guild",
          storageBucket: "brown-family-guild.firebasestorage.app",
          messagingSenderId: "894794378412",
          appId: "1:894794378412:web:cc1b03ed950c9629ebc309"
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const [iconData, setIconData] = useState(null);
            useEffect(() => {
                const checkLucide = () => {
                    if (window.lucide) {
                        const data = window.lucide[name] || (window.lucide.icons ? window.lucide.icons[name] : null);
                        if (data) setIconData(data);
                    } else { setTimeout(checkLucide, 50); }
                };
                checkLucide();
            }, [name]);
            if (!iconData) return <span style={{ width: size, height: size, display: 'inline-block' }} className={className} />;
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconData.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i }))}
                </svg>
            );
        };

        const Avatar = ({ id, size = "md" }) => {
            const dim = size === "lg" ? "w-12 h-12" : "w-10 h-10";
            const iconSize = size === "lg" ? 22 : 18;
            const avatars = {
                Eric: { icon: "DraftingCompass", bg: "bg-zinc-800" },
                Catie: { icon: "FlaskConical", bg: "bg-zinc-800" },
                Rory: { icon: "Shield", bg: "bg-zinc-800" },
                Olive: { icon: "Sparkles", bg: "bg-zinc-800" },
                Family: { icon: "Home", bg: "bg-zinc-800" }
            };
            const config = avatars[id] || avatars.Family;
            return (
                <div className={`${dim} rounded-none border border-white/20 ${config.bg} flex items-center justify-center text-white flex-shrink-0 rotate-45 shadow-lg`}>
                    <div className="-rotate-45 flex items-center justify-center">
                        <Icon name={config.icon} size={iconSize} />
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [isMeetingMode, setIsMeetingMode] = useState(false);
            const [activeFilter, setActiveFilter] = useState('All');
            const [archiveStatus, setArchiveStatus] = useState("");
            const [importText, setImportText] = useState("");
            const [showHardResetConfirm, setShowHardResetConfirm] = useState(false);

            const [guildData, setGuildData] = useState({
                familyXP: 0, familyGold: 0,
                members: [
                    { id: 'Eric', name: 'Eric', class: 'Architect', gp: 0, xp: 0 },
                    { id: 'Catie', name: 'Catie', class: 'Alchemist', gp: 0, xp: 0 },
                    { id: 'Rory', name: 'Rory', class: 'Squire', gp: 0, xp: 0 },
                    { id: 'Olive', name: 'Olive', class: 'Scout', gp: 0, xp: 0 }
                ],
                quests: [], reminders: [], claimedBonuses: { rooms: [], sanctuary: false },
                rewards: { Family: [], Eric: [], Catie: [], Rory: [], Olive: [] },
                menu: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map(d => ({ day: d, meal: 'TBD' }))
            });

            const [newQuest, setNewQuest] = useState({ title: '', type: 'daily', assignedTo: 'Family', targetValue: 1, unit: 'task' });
            const [newCleaning, setNewCleaning] = useState({ title: '', room: 'Kitchen', type: 'daily' });
            const [newReward, setNewReward] = useState({ label: '', rarity: 'Common', owner: 'Family' });
            const [newBounty, setNewBounty] = useState("");

            useEffect(() => {
                const init = async () => {
                    const app = window.FB.initializeApp(firebaseConfig);
                    const auth = window.FB.getAuth(app);
                    const firestore = window.FB.getFirestore(app);
                    setDb(firestore);
                    await window.FB.signInAnonymously(auth);
                    window.FB.onAuthStateChanged(auth, setUser);
                };
                init();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const appId = 'brown-family-guild';
                const guildDoc = window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'guildState', 'master');
                
                const unsubscribe = window.FB.onSnapshot(guildDoc, (snapshot) => {
                    if (snapshot.exists()) { setGuildData(snapshot.data()); } 
                    else { window.FB.setDoc(guildDoc, guildData); }
                }, (err) => console.error(err));
                return () => unsubscribe();
            }, [user, db]);

            const sync = async (update) => {
                if (!user || !db) return;
                const appId = 'brown-family-guild';
                const guildDoc = window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'guildState', 'master');
                try { await window.FB.updateDoc(guildDoc, update); } 
                catch (e) { await window.FB.setDoc(guildDoc, update, { merge: true }); }
            };

            const adjustManual = (id, field, amount) => {
                if (id === 'Family') {
                    const currentVal = Number(field === 'gp' ? guildData.familyGold : guildData.familyXP) || 0;
                    const update = {};
                    if (field === 'gp') update.familyGold = Math.max(0, currentVal + amount);
                    else update.familyXP = Math.max(0, currentVal + amount);
                    sync(update);
                } else {
                    const newMembers = guildData.members.map(m => {
                        if (m.id === id) {
                            const currentVal = Number(m[field] || 0);
                            return { ...m, [field]: Math.max(0, currentVal + amount) };
                        }
                        return m;
                    });
                    sync({ members: newMembers });
                }
            };

            const performHardReset = async () => {
                const initialState = {
                    familyXP: 0, familyGold: 0,
                    members: [
                        { id: 'Eric', name: 'Eric', class: 'Architect', gp: 0, xp: 0 },
                        { id: 'Catie', name: 'Catie', class: 'Alchemist', gp: 0, xp: 0 },
                        { id: 'Rory', name: 'Rory', class: 'Squire', gp: 0, xp: 0 },
                        { id: 'Olive', name: 'Olive', class: 'Scout', gp: 0, xp: 0 }
                    ],
                    quests: [], 
                    reminders: [], 
                    claimedBonuses: { rooms: [], sanctuary: false },
                    rewards: { Family: [], Eric: [], Catie: [], Rory: [], Olive: [] },
                    menu: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map(d => ({ day: d, meal: 'TBD' }))
                };
                const appId = 'brown-family-guild';
                await window.FB.setDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'guildState', 'master'), initialState);
                setArchiveStatus("Hall Purged!");
                setShowHardResetConfirm(false);
                setTimeout(() => setArchiveStatus(""), 3000);
            };

            const completeQuest = (id) => {
                const q = guildData.quests.find(x => x.id === id);
                if (!q || q.status === 'completed') return;
                const newQuests = guildData.quests.map(x => x.id === id ? { ...x, status: 'completed' } : x);
                const xpAward = Number(q.xp || 0);
                const gpAward = Number(q.reward || 0);
                const update = { quests: newQuests };
                if (q.assignedTo === 'Family') {
                    update.familyGold = Number(guildData.familyGold || 0) + gpAward;
                    update.familyXP = Number(guildData.familyXP || 0) + xpAward;
                } else {
                    update.members = guildData.members.map(m => 
                        m.id === q.assignedTo 
                        ? { ...m, gp: Number(m.gp || 0) + gpAward, xp: Number(m.xp || 0) + xpAward } 
                        : m
                    );
                }
                sync(update);
            };

            const updateQuestProgress = (id, amt) => {
                const newQuests = guildData.quests.map(x => {
                    if (x.id === id) {
                        const val = Math.max(0, Math.min((Number(x.currentValue || 0) + amt), Number(x.targetValue || 1)));
                        return { ...x, currentValue: val };
                    }
                    return x;
                });
                sync({ quests: newQuests });
            };

            const claimRoom = (room) => {
                const rooms = guildData.claimedBonuses?.rooms || [];
                if (rooms.includes(room)) return;
                sync({ 
                    familyGold: Number(guildData.familyGold || 0) + 50, 
                    familyXP: Number(guildData.familyXP || 0) + 100,
                    claimedBonuses: { ...guildData.claimedBonuses, rooms: [...rooms, room] }
                });
            };

            const completeReminder = (id) => {
                const r = guildData.reminders.find(x => x.id === id);
                if (!r || r.status === 'completed') return;
                const newReminders = guildData.reminders.map(x => x.id === id ? { ...x, status: 'completed' } : x);
                sync({ reminders: newReminders, familyGold: Number(guildData.familyGold || 0) + 10, familyXP: Number(guildData.familyXP || 0) + 10 });
            };

            const deleteQuest = (id) => sync({ quests: guildData.quests.filter(x => x.id !== id) });
            const deleteBounty = (id) => sync({ reminders: guildData.reminders.filter(x => x.id !== id) });

            const monthlyReset = () => {
                const resetQuests = guildData.quests.map(q => {
                    if (q.category === 'Cleaning') return { ...q, status: 'active' };
                    return q;
                });
                sync({ quests: resetQuests, claimedBonuses: { rooms: [], sanctuary: false } });
            };

            const exportLedger = () => {
                const blob = JSON.stringify(guildData);
                const el = document.createElement('textarea');
                el.value = blob; document.body.appendChild(el); el.select();
                document.execCommand('copy'); document.body.removeChild(el);
                setArchiveStatus("Scroll Copied!"); setTimeout(() => setArchiveStatus(""), 3000);
            };

            const restoreLedger = async () => {
                if (!user || !db) return;
                try {
                    const data = JSON.parse(importText);
                    const appId = 'brown-family-guild';
                    await window.FB.setDoc(window.FB.doc(db, 'artifacts', appId, 'public', 'data', 'guildState', 'master'), data);
                    setArchiveStatus("Restored!"); setImportText("");
                } catch(e) { setArchiveStatus("Error!"); }
            };

            const filteredQuests = (guildData.quests || []).filter(q => q.category !== 'Cleaning' && q.type !== 'campaign' && (activeFilter === 'All' || q.assignedTo === activeFilter));
            const filteredEpics = (guildData.quests || []).filter(q => q.type === 'campaign' && (activeFilter === 'All' || q.assignedTo === activeFilter));
            const cTasks = (guildData.quests || []).filter(q => q.category === 'Cleaning');
            const globalPercent = cTasks.length ? Math.round((cTasks.filter(q => q.status === 'completed').length / cTasks.length) * 100) : 0;

            if (!user) return <div className="h-screen bg-black flex flex-col items-center justify-center text-amber-500 rpg-title"><Icon name="Crown" size={48} className="mb-4 animate-pulse" />Loading Skyrim...</div>;

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        <header className="mb-10 flex flex-col gap-6">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h1 className="rpg-title text-2xl md:text-3xl font-bold flex items-center gap-4 text-white"><Icon name="Crown" size={32} /> Brown Family Guild Hall</h1>
                                    <div className="flex items-center gap-3 mt-2">
                                        <span className="text-[10px] uppercase font-bold text-zinc-500 tracking-widest">Guild Level {getLevel(guildData.familyXP)}</span>
                                        <div className="w-48 skyrim-progress-bg">
                                            {(() => {
                                                const lvl = getLevel(guildData.familyXP);
                                                const currentLvlXP = getXPForLevel(lvl);
                                                const nextLvlXP = getXPForLevel(lvl + 1);
                                                const progress = ((guildData.familyXP - currentLvlXP) / (nextLvlXP - currentLvlXP)) * 100;
                                                return <div className="skyrim-progress-fill" style={{ width: `${progress}%` }}></div>;
                                            })()}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right">
                                        <div className="text-[10px] uppercase font-bold text-zinc-500 tracking-widest">Treasury</div>
                                        <div className="text-amber-500 font-bold flex items-center gap-1 text-lg"><Icon name="Coins" size={16} /> {String(guildData.familyGold || 0)} GP</div>
                                    </div>
                                    <button onClick={() => setIsMeetingMode(!isMeetingMode)} className={`px-4 py-2 border ${isMeetingMode ? 'border-amber-500 text-amber-500' : 'border-zinc-700 text-zinc-400 hover:text-white'} text-[10px] uppercase tracking-widest transition-all`}>
                                        {isMeetingMode ? 'End Council' : 'Strategic Planning'}
                                    </button>
                                </div>
                            </div>

                            <div className="flex flex-wrap gap-4 border-b border-zinc-800 pb-6 relative">
                                <button onClick={() => setActiveFilter('All')} className={`char-card p-4 min-w-[80px] flex flex-col items-center justify-center ${activeFilter === 'All' ? 'active' : ''}`}>
                                    <Icon name="LayoutGrid" size={24} className="mb-1 text-zinc-400" /><span className="text-[10px] uppercase font-bold tracking-widest">General</span>
                                </button>
                                {(guildData.members || []).map(m => {
                                    const lvl = getLevel(m.xp);
                                    const currentLvlXP = getXPForLevel(lvl);
                                    const nextLvlXP = getXPForLevel(lvl + 1);
                                    const progress = ((m.xp - currentLvlXP) / (nextLvlXP - currentLvlXP)) * 100;
                                    
                                    return (
                                        <button key={m.id} onClick={() => setActiveFilter(m.id)} className={`char-card flex-1 min-w-[140px] p-4 text-left ${activeFilter === m.id ? 'active' : ''}`}>
                                            <div className="flex items-center gap-3 mb-2">
                                                <Avatar id={m.id} />
                                                <div className="overflow-hidden">
                                                    <span className="text-xs font-bold text-white block uppercase truncate">{String(m.name)}</span>
                                                    <div className="flex items-center gap-1">
                                                        <span className="text-[8px] uppercase font-bold text-amber-500">Lvl {lvl}</span>
                                                        <div className="flex-1 skyrim-progress-bg h-[1px] w-12"><div className="bg-amber-500 h-full" style={{ width: `${progress}%` }}></div></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <div className="text-amber-500 font-bold text-[10px]">{String(m.gp || 0)} GP</div>
                                                <div className="text-zinc-600 text-[8px] uppercase font-bold">{String(m.class || 'Member')}</div>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-10">
                            <div className="lg:col-span-2 space-y-12">
                                
                                {isMeetingMode && (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 border border-amber-900/30 p-6 bg-black/40 animate-in fade-in slide-in-from-top-2">
                                            <div className="space-y-3">
                                                <h2 className="text-[10px] uppercase font-bold text-blue-400 tracking-widest">Mission Summoner</h2>
                                                <input className="w-full p-2 text-[10px]" placeholder="Name..." value={newQuest.title} onChange={e => setNewQuest({...newQuest, title: e.target.value})} />
                                                <select className="w-full p-2 text-[10px]" value={newQuest.assignedTo} onChange={e => setNewQuest({...newQuest, assignedTo: e.target.value})}>
                                                    <option value="Family">Guild Wide</option>{guildData.members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                                </select>
                                                <select className="w-full p-2 text-[10px]" value={newQuest.type} onChange={e => setNewQuest({...newQuest, type: e.target.value})}>
                                                    <option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option><option value="campaign">Campaign</option>
                                                </select>
                                                <div className="flex gap-1">
                                                    <input className="w-1/2 p-2 text-[10px]" type="number" placeholder="Goal" onChange={e => setNewQuest({...newQuest, targetValue: Number(e.target.value)})} />
                                                    <input className="w-1/2 p-2 text-[10px]" placeholder="Unit" onChange={e => setNewQuest({...newQuest, unit: e.target.value})} />
                                                </div>
                                                <button onClick={() => {
                                                    const r = MISSION_REWARDS[newQuest.type];
                                                    const x = XP_REWARDS[newQuest.type];
                                                    sync({ quests: [...guildData.quests, {...newQuest, id: Date.now(), status: 'active', currentValue: 0, reward: r, xp: x, category: 'Personal'}]});
                                                    setNewQuest({ title: '', type: 'daily', assignedTo: 'Family', targetValue: 1, unit: 'task' });
                                                }} className="w-full py-2 bg-zinc-800 text-[9px] font-bold uppercase hover:bg-zinc-700">Add Mission</button>
                                            </div>
                                            <div className="space-y-3">
                                                <h2 className="text-[10px] uppercase font-bold text-emerald-400 tracking-widest">Sanctuary</h2>
                                                <input className="w-full p-2 text-[10px]" placeholder="Clean Task..." value={newCleaning.title} onChange={e => setNewCleaning({...newCleaning, title: e.target.value})} />
                                                <select className="w-full p-2 text-[10px]" value={newCleaning.room} onChange={e => setNewCleaning({...newCleaning, room: e.target.value})}>
                                                    {rooms_list.map(r => <option key={r} value={r}>{r}</option>)}
                                                </select>
                                                <select className="w-full p-2 text-[10px]" value={newCleaning.type} onChange={e => setNewCleaning({...newCleaning, type: e.target.value})}>
                                                    <option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option>
                                                </select>
                                                <button onClick={() => {
                                                    const rewardsMap = { daily: { gp: 5, xp: 10 }, weekly: { gp: 30, xp: 60 }, monthly: { gp: 125, xp: 250 } };
                                                    const tier = rewardsMap[newCleaning.type] || rewardsMap.daily;
                                                    sync({ quests: [...guildData.quests, {...newCleaning, id: Date.now(), assignedTo: 'Family', category: 'Cleaning', status: 'active', reward: tier.gp, xp: tier.xp, type: newCleaning.type}]});
                                                }} className="w-full py-2 bg-zinc-800 text-[9px] font-bold uppercase hover:bg-zinc-700">Add Task</button>
                                                <button onClick={monthlyReset} className="w-full py-1 text-[8px] uppercase border border-red-900 text-red-900">Reset Cleanup</button>
                                            </div>
                                            <div className="space-y-3">
                                                <h2 className="text-[10px] uppercase font-bold text-amber-400 tracking-widest">Treasury</h2>
                                                <input className="w-full p-2 text-[10px]" placeholder="Reward..." value={newReward.label} onChange={e => setNewReward({...newReward, label: e.target.value})} />
                                                <select className="w-full p-2 text-[10px]" value={newReward.owner} onChange={e => setNewReward({...newReward, owner: e.target.value})}>
                                                    <option value="Family">Vault</option>{guildData.members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                                </select>
                                                <select className="w-full p-2 text-[10px]" value={newReward.rarity} onChange={e => setNewReward({...newReward, rarity: e.target.value})}>{Object.keys(TIER_COSTS).map(t => <option key={t}>{t}</option>)}</select>
                                                <button onClick={async () => {
                                                    const upd = {...guildData.rewards}; upd[newReward.owner] = [...(upd[newReward.owner] || []), {label: newReward.label, cost: TIER_COSTS[newReward.rarity], rarity: newReward.rarity}];
                                                    await sync({ rewards: upd });
                                                }} className="w-full py-2 bg-zinc-800 text-[9px] font-bold uppercase">Add Shop</button>
                                            </div>
                                            <div className="space-y-3">
                                                <h2 className="text-[10px] uppercase font-bold text-purple-400 tracking-widest">Bounties & Data</h2>
                                                <input className="w-full p-2 text-[10px]" placeholder="Quick Bounty..." value={newBounty} onChange={e => setNewBounty(e.target.value)} />
                                                <button onClick={() => { if (!newBounty) return; sync({ reminders: [...(guildData.reminders || []), {id: Date.now(), text: newBounty, status: 'active'}] }); setNewBounty(""); }} className="w-full py-2 bg-zinc-800 text-[9px] font-bold uppercase">Post Bounty (+10G)</button>
                                                <div className="flex gap-1">
                                                    <button onClick={exportLedger} className="flex-1 py-1 border border-zinc-700 text-[8px] uppercase">{archiveStatus || 'Export'}</button>
                                                    {showHardResetConfirm ? (
                                                        <button onClick={performHardReset} className="flex-1 py-1 bg-red-700 text-white text-[8px] uppercase animate-pulse">Confirm Wipe?</button>
                                                    ) : (
                                                        <button onClick={() => setShowHardResetConfirm(true)} className="flex-1 py-1 border border-red-900 text-red-900 text-[8px] uppercase">Reset Hall</button>
                                                    )}
                                                </div>
                                                <textarea className="w-full h-8 text-[7px] p-1" placeholder="Paste data..." onChange={e => setImportText(e.target.value)} />
                                                <button onClick={restoreLedger} className="w-full py-1 text-[8px] bg-zinc-900 border border-zinc-700 uppercase">Restore</button>
                                            </div>
                                        </div>

                                        {/* MANUAL POINT ADJUSTMENT PANEL */}
                                        <div className="p-6 border border-amber-500/30 bg-black/60">
                                            <h2 className="text-[10px] uppercase font-bold text-amber-500 tracking-[0.2em] mb-4 flex items-center gap-2">
                                                <Icon name="Settings2" size={14} /> Manual Ledger Overrides
                                            </h2>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                                <div className="space-y-2 border-r border-zinc-800 pr-4">
                                                    <span className="text-[9px] font-bold text-zinc-500 uppercase">Guild (Family)</span>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-[10px]">Gold</span>
                                                        <div className="flex gap-1">
                                                            <button onClick={()=>adjustManual('Family', 'gp', -10)} className="w-8 py-1 bg-red-900/30 text-xs border border-red-900">-10</button>
                                                            <button onClick={()=>adjustManual('Family', 'gp', 10)} className="w-8 py-1 bg-green-900/30 text-xs border border-green-900">+10</button>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-[10px]">XP</span>
                                                        <div className="flex gap-1">
                                                            <button onClick={()=>adjustManual('Family', 'xp', -50)} className="w-8 py-1 bg-red-900/30 text-xs border border-red-900">-50</button>
                                                            <button onClick={()=>adjustManual('Family', 'xp', 50)} className="w-8 py-1 bg-green-900/30 text-xs border border-green-900">+50</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {guildData.members.map(m => (
                                                    <div key={m.id} className="space-y-2 border-r last:border-0 border-zinc-800 pr-4">
                                                        <span className="text-[9px] font-bold text-zinc-300 uppercase">{m.name}</span>
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-[10px]">Gold</span>
                                                            <div className="flex gap-1">
                                                                <button onClick={()=>adjustManual(m.id, 'gp', -5)} className="w-8 py-1 bg-zinc-800 text-xs hover:bg-zinc-700">-5</button>
                                                                <button onClick={()=>adjustManual(m.id, 'gp', 5)} className="w-8 py-1 bg-zinc-800 text-xs hover:bg-zinc-700">+5</button>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-[10px]">XP</span>
                                                            <div className="flex gap-1">
                                                                <button onClick={()=>adjustManual(m.id, 'xp', -20)} className="w-8 py-1 bg-zinc-800 text-xs hover:bg-zinc-700">-20</button>
                                                                <button onClick={()=>adjustManual(m.id, 'xp', 20)} className="w-8 py-1 bg-zinc-800 text-xs hover:bg-zinc-700">+20</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <section className="space-y-6">
                                    <h2 className="rpg-title text-xl font-bold text-white uppercase tracking-widest">Legendary Campaigns</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {filteredEpics.map(q => {
                                            const progress = (Number(q.currentValue || 0) / Number(q.targetValue || 1)) * 100;
                                            const isDone = progress >= 100;
                                            return (
                                                <div key={q.id} className="p-6 border border-zinc-800 bg-black/40">
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div><h3 className="text-sm font-bold text-white uppercase tracking-wider">{String(q.title)}</h3><span className="text-[9px] text-zinc-500 uppercase tracking-tighter">{String(q.assignedTo)}</span></div>
                                                        <span className="text-xs font-bold text-zinc-400">{String(q.currentValue || 0)}/{String(q.targetValue || 10)} {String(q.unit || '')}</span>
                                                    </div>
                                                    <div className="skyrim-progress-bg mb-6"><div className="skyrim-progress-fill amber" style={{ width: `${progress}%` }}></div></div>
                                                    <div className="flex gap-2">
                                                        {q.status !== 'completed' ? (
                                                            <>
                                                                <button onClick={() => updateQuestProgress(q.id, 1)} className="flex-1 py-1 border border-zinc-800 text-[9px] uppercase font-bold hover:border-zinc-500 transition-all">+1 Progress</button>
                                                                {isDone && <button onClick={() => completeQuest(q.id)} className="px-4 py-1 bg-amber-600 text-black text-[9px] uppercase font-bold animate-pulse">Claim {String(q.reward || 1000)}G</button>}
                                                            </>
                                                        ) : <div className="text-[9px] uppercase font-bold text-zinc-600 italic">Campaign Complete</div>}
                                                        {isMeetingMode && <button onClick={() => deleteQuest(q.id)} className="p-2 text-red-900 hover:text-red-500 transition-colors"><Icon name="Trash2" size={14} /></button>}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>

                                <section className="space-y-6">
                                    <div className="flex justify-between items-end"><h2 className="rpg-title text-xl font-bold text-white uppercase tracking-widest">Sanctuary</h2><div className="text-right text-[10px] uppercase font-bold text-zinc-500">Clearance: {globalPercent}%</div></div>
                                    <div className="max-h-[300px] overflow-y-auto pr-4 custom-scrollbar grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {rooms_list.map(room => {
                                            const rQuests = (guildData.quests || []).filter(q => q.room === room);
                                            const rPercent = rQuests.length ? Math.round((rQuests.filter(q => q.status === 'completed').length / rQuests.length) * 100) : 0;
                                            const clrd = rPercent === 100;
                                            return (
                                                <div key={room} className={`p-4 border ${clrd ? 'border-amber-900 bg-amber-950/10' : 'border-zinc-800 bg-black/20'} transition-all`}>
                                                    <div className="flex justify-between mb-2"><h3 className={`text-[10px] uppercase font-bold tracking-widest ${clrd ? 'text-amber-500' : 'text-zinc-300'}`}>{String(room)}</h3><span className="text-[9px] text-zinc-500">{rPercent}%</span></div>
                                                    <div className="skyrim-progress-bg mb-3"><div className={`h-full ${clrd ? 'bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)]' : 'bg-white/30'}`} style={{ width: `${rPercent}%` }}></div></div>
                                                    <div className="space-y-1">
                                                        {rQuests.map(q => (
                                                            <div key={q.id} className="flex items-center gap-2 text-[9px] group">
                                                                <button onClick={() => completeQuest(q.id)} className={`p-0.5 border transition-all ${q.status === 'completed' ? 'border-amber-500 text-amber-500' : 'border-zinc-700 hover:border-zinc-400'}`}><Icon name="Check" size={8} /></button>
                                                                <span className={`truncate ${q.status === 'completed' ? 'line-through text-zinc-600' : 'text-zinc-400'}`}>
                                                                    <span className="text-[8px] opacity-50 mr-1 uppercase">[{String(q.type || 'D')[0]}]</span>
                                                                    {String(q.title)}
                                                                </span>
                                                                {isMeetingMode && <button onClick={() => deleteQuest(q.id)} className="ml-auto text-red-900 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="Trash2" size={10}/></button>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    {clrd && !(guildData.claimedBonuses?.rooms || []).includes(room) && <button onClick={() => claimRoom(room)} className="mt-3 w-full border border-amber-700 text-amber-600 text-[8px] font-bold py-1 uppercase hover:bg-amber-700 hover:text-black transition-all tracking-widest">Collect Bonus</button>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>

                                <section className="space-y-6">
                                    <h2 className="rpg-title text-xl font-bold text-white uppercase tracking-widest">Active Missions</h2>
                                    <div className="max-h-[300px] overflow-y-auto pr-4 custom-scrollbar space-y-2">
                                        {filteredQuests.map(q => {
                                            const progress = (Number(q.currentValue || 0) / Number(q.targetValue || 1)) * 100;
                                            const isScalable = Number(q.targetValue) > 1;
                                            return (
                                                <div key={q.id} className={`flex flex-col p-4 border transition-all ${q.status === 'completed' ? 'border-zinc-900 opacity-50 shadow-none' : 'border-zinc-800 bg-black/40 shadow-lg shadow-black/50'}`}>
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-4 overflow-hidden">
                                                            <Icon name={q.status === 'completed' ? 'CheckCircle' : 'Zap'} size={18} className={q.status === 'completed' ? 'text-zinc-700' : 'text-zinc-400'} />
                                                            <div className="overflow-hidden">
                                                                <div className="flex items-center gap-2">
                                                                    <h3 className="text-xs font-bold uppercase text-white tracking-wider truncate">{String(q.title)}</h3>
                                                                    <span className={`text-[7px] px-1 font-bold uppercase border ${q.type === 'monthly' ? 'text-purple-400 border-purple-900' : q.type === 'weekly' ? 'text-blue-400 border-blue-900' : 'text-zinc-500 border-zinc-800'}`}>{String(q.type)}</span>
                                                                </div>
                                                                <div className="text-[9px] font-bold text-zinc-500 uppercase tracking-tighter">{String(q.assignedTo)} â€¢ +{String(q.reward || 0)} GP</div>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-2 flex-shrink-0">
                                                            {q.status === 'active' && (
                                                                <>
                                                                    {isScalable && <button onClick={() => updateQuestProgress(q.id, 1)} className="text-[9px] uppercase font-bold border border-zinc-800 px-3 py-1 hover:border-zinc-500 transition-all">+1 {q.unit}</button>}
                                                                    {(progress >= 100 || !isScalable) && <button onClick={() => completeQuest(q.id)} className="text-[9px] uppercase font-bold border border-zinc-700 px-4 py-1 hover:border-white transition-all active:scale-95 bg-zinc-900">Claim</button>}
                                                                </>
                                                            )}
                                                            {isMeetingMode && <button onClick={() => deleteQuest(q.id)} className="text-red-900 p-2 hover:text-red-500 transition-colors"><Icon name="Trash2" size={14} /></button>}
                                                        </div>
                                                    </div>
                                                    {isScalable && q.status === 'active' && (
                                                        <div className="mt-3">
                                                            <div className="flex justify-between text-[8px] uppercase font-bold text-zinc-500 mb-1">
                                                                <span>Progress</span>
                                                                <span>{q.currentValue}/{q.targetValue} {q.unit}</span>
                                                            </div>
                                                            <div className="skyrim-progress-bg"><div className="skyrim-progress-fill" style={{ width: `${progress}%` }}></div></div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>

                                <section className="space-y-6">
                                    <h2 className="rpg-title text-xl font-bold text-white uppercase tracking-widest">Bounties</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {(guildData.reminders || []).map(r => (
                                            <div key={r.id} className="flex items-center justify-between p-3 border border-zinc-800 bg-black/20 transition-all">
                                                <div className="flex items-center gap-3 overflow-hidden">
                                                    <button onClick={() => completeReminder(r.id)} className={`p-1 border transition-all ${r.status === 'completed' ? 'border-zinc-800 text-zinc-800' : 'border-zinc-600 text-zinc-400 hover:border-white hover:text-white'}`}><Icon name="Check" size={10} /></button>
                                                    <span className={`text-[11px] truncate uppercase tracking-wide ${r.status === 'completed' ? 'text-zinc-700 font-normal' : 'text-zinc-300 font-medium'}`}>{String(r.text)}</span>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    {r.status === 'active' && <span className="text-[8px] font-bold text-amber-700 tracking-tighter">+10G</span>}
                                                    {isMeetingMode && <button onClick={() => deleteBounty(r.id)} className="text-red-900 p-1 hover:text-red-500 transition-colors"><Icon name="Trash2" size={12}/></button>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>
                            </div>

                            <div className="space-y-10">
                                <section className="p-8 border border-zinc-800 bg-black/40">
                                    <h2 className="rpg-title text-xs font-bold mb-6 text-white uppercase tracking-[0.3em]">Ration Plan</h2>
                                    <div className="space-y-4">
                                        {(guildData.menu || []).map((m, i) => (
                                            <div key={i} className="flex flex-col gap-1">
                                                <span className="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">{String(m.day)}</span>
                                                {isMeetingMode ? <input className="bg-black/60 p-1 text-xs text-white border border-zinc-800" value={String(m.meal || '')} onChange={e => {
                                                    const nm = [...guildData.menu]; nm[i] = {...nm[i], meal: e.target.value}; sync({ menu: nm });
                                                }} /> : <span className="text-xs font-bold uppercase tracking-widest text-zinc-300 truncate">{String(m.meal || 'TBD')}</span>}
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                <section className="p-8 border border-zinc-800 bg-black/60 flex flex-col max-h-[450px]">
                                    <h2 className="rpg-title text-xs font-bold mb-8 text-white uppercase tracking-[0.3em]">Treasury</h2>
                                    <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-8">
                                        {Object.entries(guildData.rewards || {}).map(([owner, items]) => {
                                            if (activeFilter !== 'All' && activeFilter !== owner) return null;
                                            return (
                                                <div key={owner}>
                                                    <div className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-4 border-l border-amber-900 pl-2">{String(owner === 'Family' ? 'Guild Vault' : owner)}</div>
                                                    <div className="space-y-4">
                                                        {(items || []).map(r => (
                                                            <div key={r.label} className="group flex justify-between items-center border-b border-zinc-900 pb-2 hover:bg-white/5 transition-all px-1">
                                                                <div><div className="text-xs font-bold text-white uppercase tracking-wider">{String(r.label)}</div><div className={`text-[8px] uppercase text-zinc-500 tracking-tighter`}>{String(r.rarity)}</div></div>
                                                                <div className="flex items-center gap-2 flex-shrink-0"><span className="text-amber-500 text-xs font-bold tracking-tighter">{String(r.cost)} GP</span>{isMeetingMode && <button onClick={() => {
                                                                    const upd = {...guildData.rewards}; upd[owner] = upd[owner].filter(x => x.label !== r.label); sync({ rewards: upd });
                                                                }} className="text-red-900 p-1 hover:text-red-500 transition-colors"><Icon name="XCircle" size={14} /></button>}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>